package cc.unknown.module.impl.exploit;

import java.util.ArrayList;
import java.util.Iterator;

import cc.unknown.event.impl.EventLink;
import cc.unknown.event.impl.move.PreMotionEvent;
import cc.unknown.event.impl.network.PacketEvent;
import cc.unknown.event.impl.network.PacketEvent.Type;
import cc.unknown.module.impl.Module;
import cc.unknown.module.impl.api.Category;
import cc.unknown.module.impl.api.Register;
import cc.unknown.module.setting.impl.SliderValue;
import cc.unknown.utils.network.PacketUtil;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C00PacketKeepAlive;
import net.minecraft.network.play.client.C01PacketChatMessage;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C0FPacketConfirmTransaction;
import net.minecraft.network.play.client.C16PacketClientStatus;

@Register(name = "FakeLag", category = Category.Exploit)
public class FakeLag extends Module {

	private SliderValue packetsCount = new SliderValue("Packets Count", 10, 1, 30, 1);
	private ArrayList<Packet<?>> packetlist = new ArrayList<>();
	private int packets = 0;

	public FakeLag() {
		this.registerSetting(packetsCount);
	}

	@Override
	public void onDisable() {
		super.onDisable();
		packetlist.clear();
		packets = 0;
	}

	@EventLink
	public void onPacket(PacketEvent e) {
		if (e.getType() == Type.SEND) {
			final Packet<?> p = e.getPacket();
			if (p instanceof C00PacketKeepAlive || p instanceof C01PacketChatMessage
					|| p instanceof C16PacketClientStatus || p instanceof C0FPacketConfirmTransaction)
				return;

			if (mc.thePlayer != null && packets < packetsCount.getInputToFloat()) {
				packetlist.add(p);
				if (p instanceof C03PacketPlayer) {
					++packets;
				}
				e.setCancelled(true);
			}
		}
	}

	@EventLink
	public void onPre(PreMotionEvent e) {
		if (packets >= packetsCount.getInputToFloat()) {
			Iterator<?> var3 = packetlist.iterator();

			while (var3.hasNext()) {
				Packet<?> p = (Packet<?>) var3.next();
				PacketUtil.send(p);
			}

			packetlist.clear();
			packets = 0;
		}

	}
}
