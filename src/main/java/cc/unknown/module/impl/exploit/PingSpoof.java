package cc.unknown.module.impl.exploit;

import static cc.unknown.utils.player.PlayerUtil.inGame;

import java.util.ArrayList;

import cc.unknown.event.impl.EventLink;
import cc.unknown.event.impl.network.PacketEvent;
import cc.unknown.event.impl.network.PacketEvent.Type;
import cc.unknown.event.impl.render.Render3DEvent;
import cc.unknown.module.Module;
import cc.unknown.module.impl.ModuleCategory;
import cc.unknown.module.setting.impl.SliderValue;
import cc.unknown.utils.helpers.MathHelper;
import cc.unknown.utils.network.PacketUtil;
import cc.unknown.utils.network.packets.KeepAliveS2CPacket;
import net.minecraft.network.play.client.C00PacketKeepAlive;

public class PingSpoof extends Module {

	private final ArrayList<KeepAliveS2CPacket> s2c = new ArrayList<>();

	private SliderValue delay = new SliderValue("Delay", 1900, 0, 1900, 1);

	public PingSpoof() {
		super("PingSpoof", ModuleCategory.Exploit);
		this.registerSetting(delay);
	}

	@EventLink
	public void onPacket(PacketEvent e) {
		if (e.getType() == Type.SEND) {
			if (e.getPacket() instanceof C00PacketKeepAlive) {
				C00PacketKeepAlive c00 = (C00PacketKeepAlive) e.getPacket();
				s2c.add(new KeepAliveS2CPacket(c00.getKey(), (long) ((double) System.currentTimeMillis() + delay.getInput() + (double) MathHelper.nextLong(0L, 200L))));
				e.setCancelled(true);
			}
		}
	}

	@EventLink
	public void onRender3D(Render3DEvent e) {
		if (inGame() && !s2c.isEmpty()) {
			ArrayList<KeepAliveS2CPacket> toRemove = new ArrayList<>();
			for (KeepAliveS2CPacket packet : s2c) {
				if (packet.getTime() < System.currentTimeMillis()) {
					PacketUtil.sendPacketNoEvent(new C00PacketKeepAlive(packet.getKey()));
					toRemove.add(packet);
				}
			}
			s2c.removeIf(toRemove::contains);
		}
	}
}
